<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f0c29">
    <title>TON Reward DJDN v7.0 - Professional Edition</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* =====================================================
           @region CSS VARIABLES & RESET
        ===================================================== */
        :root {
            /* Color Palette */
            --primary-bg: #0f0c29;
            --secondary-bg: #302b63;
            --tertiary-bg: #24243e;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-muted: rgba(255, 255, 255, 0.6);
            --accent-gold: #ffd700;
            --accent-gold-light: #ffed4e;
            --accent-purple: #667eea;
            --accent-purple-dark: #764ba2;
            --accent-green: #4CAF50;
            --accent-red: #f44336;
            --accent-orange: #ff9800;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 25px;
            --radius-full: 50%;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(255, 215, 0, 0.4);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 300ms ease;
            --transition-slow: 500ms ease;
            
            /* Z-index layers */
            --z-base: 1;
            --z-dropdown: 1000;
            --z-modal: 2000;
            --z-toast: 3000;
            --z-nav: 100;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, var(--tertiary-bg) 100%);
            color: var(--text-primary);
        }
        
        /* =====================================================
           @region UTILITY CLASSES
        ===================================================== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }
        .gap-lg { gap: var(--spacing-lg); }
        .text-center { text-align: center; }
        .text-bold { font-weight: 700; }
        .text-muted { color: var(--text-muted); }
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* =====================================================
           @region APP LAYOUT
        ===================================================== */
        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .app-header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--card-border);
            flex-shrink: 0;
            z-index: var(--z-nav);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 600;
        }
        
        .user-level {
            font-size: 11px;
            color: var(--accent-gold);
            font-weight: 700;
        }
        
        .balance-display {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--shadow-md);
        }
        
        /* Main Content */
        .app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--spacing-md);
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            border-top: 1px solid var(--card-border);
            z-index: var(--z-nav);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition-base);
            border-radius: var(--radius-sm);
            margin: 0 2px;
            position: relative;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-item.active {
            background: rgba(255, 215, 0, 0.15);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .nav-item.active .nav-label {
            color: var(--accent-gold);
        }
        
        .nav-badge {
            position: absolute;
            top: 4px;
            right: 8px;
            background: var(--accent-red);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* =====================================================
           @region COMPONENTS
        ===================================================== */
        
        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            border: 2px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Buttons */
        .btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            color: #333;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #8BC34A 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red) 0%, #e91e63 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-sm {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 12px;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: var(--spacing-xs);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background: linear-gradient(135deg, var(--accent-green) 0%, #8BC34A 100%);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing-sm);
            animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s;
            font-weight: 600;
            text-align: center;
            pointer-events: auto;
        }
        
        .toast.error {
            background: linear-gradient(135deg, var(--accent-red) 0%, #e91e63 100%);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, var(--accent-orange) 0%, #ff5722 100%);
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        
        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: var(--spacing-sm);
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: var(--spacing-md);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        .modal {
            background: var(--secondary-bg);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: var(--transition-fast);
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--card-border);
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition-base);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        /* =====================================================
           @region TAB-SPECIFIC STYLES
        ===================================================== */
        
        /* Home Tab */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }
        
        .action-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            border: 2px solid var(--card-border);
            cursor: pointer;
            transition: var(--transition-base);
        }
        
        .action-card:active {
            transform: scale(0.95);
        }
        
        .action-card:hover {
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-glow);
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: var(--spacing-sm);
        }
        
        .action-title {
            font-size: 13px;
            font-weight: 700;
        }
        
        /* Mining Card */
        .mining-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(15px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            border: 2px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        
        .mining-icon {
            font-size: 80px;
            margin-bottom: var(--spacing-md);
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        }
        
        .mining-reward {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-gold);
            margin: var(--spacing-md) 0;
        }
        
        .mining-timer {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }
        
        /* Task Card */
        .task-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            border: 2px solid var(--card-border);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            transition: var(--transition-base);
        }
        
        .task-card:hover {
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-glow);
        }
        
        .task-icon {
            font-size: 40px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }
        
        .task-info {
            flex: 1;
        }
        
        .task-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .task-reward {
            font-size: 13px;
            color: var(--accent-gold);
            font-weight: 600;
        }
        
        .task-progress {
            margin-top: var(--spacing-sm);
        }
        
        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--card-bg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            border: 1px solid var(--card-border);
        }
        
        .leaderboard-rank {
            font-size: 18px;
            font-weight: 700;
            width: 40px;
            text-align: center;
        }
        
        .leaderboard-rank.top-3 {
            font-size: 24px;
        }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 var(--spacing-md);
            font-size: 18px;
        }
        
        .leaderboard-info {
            flex: 1;
        }
        
        .leaderboard-name {
            font-size: 14px;
            font-weight: 600;
        }
        
        .leaderboard-level {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .leaderboard-stats {
            text-align: right;
        }
        
        .leaderboard-ads {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        /* Wheel */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: var(--spacing-xl) auto;
        }
        
        .wheel-canvas {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }
        
        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 36px solid var(--accent-gold);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            z-index: 10;
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-dark) 100%);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            border: 4px solid var(--accent-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            z-index: 5;
        }
        
        /* Level Progress */
        .level-progress-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(15px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            border: 2px solid var(--accent-gold);
            box-shadow: var(--shadow-glow);
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .current-level {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: var(--spacing-sm);
        }
        
        .xp-display {
            font-size: 24px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }
        
        .level-multiplier {
            background: rgba(255, 215, 0, 0.15);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            display: inline-block;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        /* Countdown Timer */
        .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(255, 152, 0, 0.15);
            border-radius: var(--radius-md);
            font-weight: 700;
            color: var(--accent-orange);
        }
        
        /* Info Box */
        .info-box {
            background: rgba(76, 175, 80, 0.15);
            border: 2px solid rgba(76, 175, 80, 0.4);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .warning-box {
            background: rgba(255, 152, 0, 0.15);
            border: 2px solid rgba(255, 152, 0, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .error-box {
            background: rgba(244, 67, 54, 0.15);
            border: 2px solid rgba(244, 67, 54, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        /* Checklist */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) 0;
        }
        
        .checklist-icon {
            font-size: 20px;
        }
        
        .checklist-icon.complete {
            color: var(--accent-green);
        }
        
        .checklist-icon.incomplete {
            color: var(--text-muted);
        }
        
        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-gold);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            gap: var(--spacing-md);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 14px;
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 700;
        }
        
        .badge-success {
            background: var(--accent-green);
            color: white;
        }
        
        .badge-warning {
            background: var(--accent-orange);
            color: white;
        }
        
        .badge-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .badge-gold {
            background: var(--accent-gold);
            color: #333;
        }
        
        /* Tabs (Sub-navigation) */
        .sub-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .sub-tab {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            font-size: 13px;
            transition: var(--transition-base);
        }
        
        .sub-tab.active {
            background: var(--accent-gold);
            color: #333;
            border-color: var(--accent-gold);
        }
        
        /* History Item */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .history-icon {
            font-size: 24px;
            margin-right: var(--spacing-md);
        }
        
        .history-info {
            flex: 1;
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .history-time {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .history-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        /* Responsive */
        @media (max-width: 360px) {
            .app-header {
                padding: var(--spacing-sm);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .mining-icon {
                font-size: 60px;
            }
            
            .wheel-container {
                width: 250px;
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- =====================================================
         @region APP STRUCTURE
    ===================================================== -->
    <div id="app">
        <!-- Header -->
        <div class="app-header">
            <div class="user-info">
                <div class="avatar">üë§</div>
                <div>
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-level" id="userLevel">Bronze</div>
                </div>
            </div>
            <div class="balance-display" id="balanceDisplay">0.000000 TON</div>
        </div>
        
        <!-- Main Content -->
        <div class="app-content" id="appContent">
            <!-- Tab contents will be rendered here -->
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav">
            <div class="nav-item active" data-tab="home">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" data-tab="earn">
                <div class="nav-icon">üì∫</div>
                <div class="nav-label">Earn</div>
            </div>
            <div class="nav-item" data-tab="mining">
                <div class="nav-icon">‚õèÔ∏è</div>
                <div class="nav-label">Mining</div>
            </div>
            <div class="nav-item" data-tab="tasks">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">Tasks</div>
                <div class="nav-badge hidden" id="tasksBadge">0</div>
            </div>
            <div class="nav-item" data-tab="more">
                <div class="nav-icon">‚ãØ</div>
                <div class="nav-label">More</div>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Modal Overlay -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal" id="modalContent"></div>
        </div>
    </div>
    
    <!-- =====================================================
         @region JAVASCRIPT APPLICATION
    ===================================================== -->
    <script type="module">
        // =====================================================
        // @region CONFIGURATION & CONSTANTS
        // =====================================================
        const CONFIG = {
            API_URL: 'https://ton-reward-djdn-backend.onrender.com',
            BOT_USERNAME: 'TONRewardCrewBot',
            CHANNEL_USERNAME: 'TONRewardCrew',
            WITHDRAW_CHANNEL_USERNAME: 'djdn_withdraw_payments',
            SUPPORT_USERNAME: 'djdn_crew_support',
            
            LEVELS: {
                BRONZE: { name: 'Bronze', minXP: 0, maxXP: 1999, multiplier: 1.0, color: '#CD7F32' },
                SILVER: { name: 'Silver', minXP: 2000, maxXP: 3999, multiplier: 1.02, color: '#C0C0C0' },
                GOLD: { name: 'Gold', minXP: 4000, maxXP: 5999, multiplier: 1.04, color: '#FFD700' },
                PLATINUM: { name: 'Platinum', minXP: 6000, maxXP: 7999, multiplier: 1.06, color: '#E5E4E2' },
                DIAMOND: { name: 'Diamond', minXP: 8000, maxXP: Infinity, multiplier: 1.08, color: '#B9F2FF' }
            },
            
            XP_PER_AD: 2,
            DAILY_ADS_TO_MAINTAIN: 300,
            
            LIMITS: {
                WATCH_SIMPLE_BATCH: 200,
                WATCH_SIMPLE_MAX: 1000,
                LUCKY_WHEEL_BATCH: 50,
                LUCKY_WHEEL_MAX: 250,
                WITHDRAW_ADS_REQUIRED: 5
            }
        };
        
        // =====================================================
        // @region GLOBAL STATE
        // =====================================================
        const store = {
            auth: {
                telegram: null,
                isTestUser: false,
                sessionToken: null
            },
            
            profile: {
                telegram_id: null,
                username: null,
                first_name: null,
                balance: 0,
                level: 'BRONZE',
                xp: 0,
                coins_current: 0,
                
                // Daily stats
                daily_ads_count: 0,
                daily_mining_opens: 0,
                daily_ads_watched_for_xp: 0,
                ads_watch_simple_today: 0,
                ads_for_coins_today: 0,
                coins_spent_today: 0,
                
                // Totals
                earnings_total: 0,
                total_withdrawn: 0,
                invitations_count: 0,
                
                // Tasks
                tasks_done: [],
                mandatory_tasks_completed: false,
                
                // Cooldowns
                ads_watch_simple_last_watch: null,
                ads_for_coins_last_watch: null,
                ads_watch_simple_batch_cooldown_until: null,
                ads_for_coins_batch_cooldown_until: null,
                
                // Mining
                mining_start_time: null,
                
                // Withdraw
                withdraw_ads_watched_current: 0,
                
                // Leaderboard
                daily_rank: 0
            },
            
            leaderboard: {
                top50: [],
                me: { rank: 0, adsToday: 0 },
                expiresAtUTC: null
            },
            
            tasks: {
                daily: [],
                oneTime: []
            },
            
            limits: null,
            
            ui: {
                activeTab: 'home',
                activeSubTab: null,
                loading: false,
                initialized: false
            },
            
            timers: {
                mining: null,
                watchSimpleCooldown: null,
                watchCoinsCooldown: null,
                resetCountdown: null,
                leaderboardRefresh: null
            },
            
            runtime: {
                serverTimeOffset: 0,
                lastSync: null
            }
        };
        
        // =====================================================
        // @region TELEGRAM WEBAPP INITIALIZATION
        // =====================================================
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.ready();
            tg.setHeaderColor('#0f0c29');
            tg.setBackgroundColor('#0f0c29');
        }
        
        // =====================================================
        // @region UTILITY FUNCTIONS
        // =====================================================
        
        function getServerTime() {
            return Date.now() + store.runtime.serverTimeOffset;
        }
        
        function formatTON(amount) {
            return typeof amount === 'number' ? amount.toFixed(6) : '0.000000';
        }
        
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((getServerTime() - new Date(date).getTime()) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function getNextUTCMidnight() {
            const now = new Date();
            return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0, 0));
        }
        
        function getTimeUntilReset() {
            return getNextUTCMidnight().getTime() - getServerTime();
        }
        
        function calculateLevel(xp) {
            if (xp >= CONFIG.LEVELS.DIAMOND.minXP) return 'DIAMOND';
            if (xp >= CONFIG.LEVELS.PLATINUM.minXP) return 'PLATINUM';
            if (xp >= CONFIG.LEVELS.GOLD.minXP) return 'GOLD';
            if (xp >= CONFIG.LEVELS.SILVER.minXP) return 'SILVER';
            return 'BRONZE';
        }
        
        function getLevelInfo(level) {
            return CONFIG.LEVELS[level] || CONFIG.LEVELS.BRONZE;
        }
        
        function getNextLevel(currentLevel) {
            const levels = ['BRONZE', 'SILVER', 'GOLD', 'PLATINUM', 'DIAMOND'];
            const currentIndex = levels.indexOf(currentLevel);
            return currentIndex < levels.length - 1 ? levels[currentIndex + 1] : null;
        }
        
        // =====================================================
        // @region API FUNCTIONS
        // =====================================================
        
        async function apiCall(endpoint, options = {}) {
            try {
                const url = `${CONFIG.API_URL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                // Update server time offset
                const serverDate = response.headers.get('Date');
                if (serverDate) {
                    store.runtime.serverTimeOffset = new Date(serverDate).getTime() - Date.now();
                }
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Network error' }));
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        async function fetchUserProfile() {
            const telegramId = store.auth.telegram?.id || 'test_' + Date.now();
            const data = await apiCall(`/user/${telegramId}`);
            
            // Update profile
            Object.assign(store.profile, data);
            
            // Update UI
            updateHeader();
            
            return data;
        }
        
        async function createUser(telegramId, username, firstName, referrerId) {
            return await apiCall('/user', {
                method: 'POST',
                body: JSON.stringify({
                    telegram_id: telegramId,
                    username,
                    first_name: firstName,
                    referrer_id: referrerId
                })
            });
        }
        
        async function fetchLeaderboard() {
            const data = await apiCall('/leaderboard?limit=50');
            store.leaderboard.top50 = data.leaderboard || [];
            store.leaderboard.expiresAtUTC = getNextUTCMidnight().getTime();
            return data;
        }
        
        async function fetchUserRank() {
            const telegramId = store.profile.telegram_id;
            if (!telegramId) return;
            
            const data = await apiCall(`/leaderboard/${telegramId}/rank`);
            store.leaderboard.me = {
                rank: data.rank || 0,
                adsToday: data.ads_count || 0
            };
            return data;
        }
        
        async function watchAd(type) {
            const telegramId = store.profile.telegram_id;
            let endpoint;
            
            switch(type) {
                case 'simple':
                    endpoint = `/earn/watch-simple/${telegramId}`;
                    break;
                case 'coin':
                    endpoint = `/earn/watch-for-coin/${telegramId}`;
                    break;
                case 'withdraw':
                    endpoint = `/withdraw/${telegramId}/watch-ad`;
                    break;
                default:
                    throw new Error('Invalid ad type');
            }
            
            const data = await apiCall(endpoint, { method: 'POST' });
            Object.assign(store.profile, data);
            updateHeader();
            return data;
        }
        
        async function spinWheel() {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/earn/spin-wheel/${telegramId}`, { method: 'POST' });
            Object.assign(store.profile, data);
            updateHeader();
            return data;
        }
        
        async function startMining() {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/mining/${telegramId}/start`, { method: 'POST' });
            Object.assign(store.profile, data);
            updateHeader();
            return data;
        }
        
        async function claimMining() {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/mining/${telegramId}/claim`, { method: 'POST' });
            Object.assign(store.profile, data);
            updateHeader();
            return data;
        }
        
        async function verifyTask(taskType) {
            const telegramId = store.profile.telegram_id;
            return await apiCall(`/task/${telegramId}/verify`, {
                method: 'POST',
                body: JSON.stringify({ task_type: taskType })
            });
        }
        
        async function claimTask(taskType) {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/task/${telegramId}/claim`, {
                method: 'POST',
                body: JSON.stringify({ task_type: taskType })
            });
            Object.assign(store.profile, data);
            updateHeader();
            return data;
        }
        
        async function fetchQuestsProgress() {
            const telegramId = store.profile.telegram_id;
            return await apiCall(`/quests/${telegramId}/progress`);
        }
        
        async function claimQuest(questNumber) {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/quests/${telegramId}/claim/${questNumber}`, {
                method: 'POST'
            });
            if (data.user) {
                Object.assign(store.profile, data.user);
                updateHeader();
            }
            return data;
        }
        
        async function submitWithdraw(email, amount) {
            const telegramId = store.profile.telegram_id;
            const data = await apiCall(`/withdraw/${telegramId}`, {
                method: 'POST',
                body: JSON.stringify({
                    faucetpay_email: email,
                    amount: parseFloat(amount)
                })
            });
            if (data.user) {
                Object.assign(store.profile, data.user);
                updateHeader();
            }
            return data;
        }
        
        // =====================================================
        // @region UI FUNCTIONS
        // =====================================================
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function updateHeader() {
            document.getElementById('userName').textContent = store.profile.first_name || store.profile.username || 'User';
            document.getElementById('userLevel').textContent = store.profile.level || 'BRONZE';
            document.getElementById('balanceDisplay').textContent = `${formatTON(store.profile.balance)} TON`;
        }
        
        function showModal(content) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('modalContent');
            modal.innerHTML = content;
            overlay.classList.add('active');
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            };
        }
        
        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('active');
        }
        
        function switchTab(tabName) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.tab === tabName);
            });
            
            // Update store
            store.ui.activeTab = tabName;
            
            // Render tab
            renderActiveTab();
            
            // Scroll to top
            document.getElementById('appContent').scrollTop = 0;
        }
        
        function renderActiveTab() {
            const content = document.getElementById('appContent');
            
            switch(store.ui.activeTab) {
                case 'home':
                    renderHomeTab(content);
                    break;
                case 'earn':
                    renderEarnTab(content);
                    break;
                case 'mining':
                    renderMiningTab(content);
                    break;
                case 'tasks':
                    renderTasksTab(content);
                    break;
                case 'more':
                    renderMoreTab(content);
                    break;
                default:
                    content.innerHTML = '<div class="empty-state"><div class="empty-icon">üöß</div><div class="empty-text">Coming soon...</div></div>';
            }
        }
        
        // =====================================================
        // @region TAB RENDERERS
        // =====================================================
        
        function renderHomeTab(container) {
            const timeUntilReset = getTimeUntilReset();
            const levelInfo = getLevelInfo(store.profile.level);
            const nextLevel = getNextLevel(store.profile.level);
            const xpNeeded = nextLevel ? CONFIG.LEVELS[nextLevel].minXP - store.profile.xp : 0;
            const adsNeeded = Math.max(0, CONFIG.DAILY_ADS_TO_MAINTAIN - store.profile.daily_ads_watched_for_xp);
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Welcome Back! üëã</h2>
                            <div class="card-subtitle">Ready to earn TON?</div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.level}</div>
                            <div class="stat-label">Current Level</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.xp}</div>
                            <div class="stat-label">Total XP</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.daily_ads_count}</div>
                            <div class="stat-label">Ads Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.leaderboard.me.rank || '‚Äî'}</div>
                            <div class="stat-label">Daily Rank</div>
                        </div>
                    </div>
                    
                    ${adsNeeded > 0 && store.profile.level !== 'BRONZE' ? `
                        <div class="warning-box" style="margin-top: 16px;">
                            <div style="font-weight: 700; margin-bottom: 8px;">‚ö†Ô∏è Level Downgrade Warning</div>
                            <div style="font-size: 13px;">Watch ${adsNeeded} more ads today to maintain your ${store.profile.level} level!</div>
                        </div>
                    ` : ''}
                    
                    ${nextLevel ? `
                        <div class="info-box" style="margin-top: 16px;">
                            <div style="font-weight: 700; margin-bottom: 8px;">üéØ Next Level: ${nextLevel}</div>
                            <div style="font-size: 13px; margin-bottom: 8px;">You need ${xpNeeded} more XP (${Math.ceil(xpNeeded / CONFIG.XP_PER_AD)} ads)</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(store.profile.xp / CONFIG.LEVELS[nextLevel].minXP) * 100}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 12px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <span>‚è∞</span>
                        <span>Daily reset in: <strong id="homeResetTimer">${formatDuration(timeUntilReset)}</strong></span>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 16px;">‚ö° Quick Actions</h3>
                    <div class="quick-actions">
                        <div class="action-card" onclick="window.app.switchTab('earn')">
                            <div class="action-icon">üì∫</div>
                            <div class="action-title">Watch Ads</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                ${store.profile.ads_watch_simple_today}/${CONFIG.LIMITS.WATCH_SIMPLE_MAX}
                            </div>
                        </div>
                        
                        <div class="action-card" onclick="window.app.switchTab('mining')">
                            <div class="action-icon">‚õèÔ∏è</div>
                            <div class="action-title">Mining</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                ${store.profile.mining_start_time ? 'Active' : 'Ready'}
                            </div>
                        </div>
                        
                        <div class="action-card" onclick="window.app.switchTab('tasks')">
                            <div class="action-icon">üìã</div>
                            <div class="action-title">Tasks</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                Earn more
                            </div>
                        </div>
                        
                        <div class="action-card" onclick="window.app.showLeaderboard()">
                            <div class="action-icon">üèÜ</div>
                            <div class="action-title">Leaderboard</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                Rank #${store.leaderboard.me.rank || '‚Äî'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 16px;">üìä Your Progress</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${formatTON(store.profile.earnings_total)}</div>
                            <div class="stat-label">Total Earned</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatTON(store.profile.total_withdrawn)}</div>
                            <div class="stat-label">Total Withdrawn</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.invitations_count || 0}</div>
                            <div class="stat-label">Friends Invited</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.coins_current || 0}</div>
                            <div class="stat-label">Coins Available</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Start countdown timer
            startResetCountdownTimer('homeResetTimer');
        }
        
        function renderEarnTab(container) {
            const simpleToday = store.profile.ads_watch_simple_today || 0;
            const simpleRemaining = CONFIG.LIMITS.WATCH_SIMPLE_MAX - simpleToday;
            const simpleBatchProgress = store.profile.ads_watch_simple_batch_count || 0;
            
            const coinsToday = store.profile.ads_for_coins_today || 0;
            const coinsRemaining = CONFIG.LIMITS.LUCKY_WHEEL_MAX - coinsToday;
            const coinsBatchProgress = store.profile.ads_for_coins_batch_count || 0;
            
            const timeUntilReset = getTimeUntilReset();
            
            container.innerHTML = `
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 8px;">üí∞ Earn TON Rewards</h2>
                    <div class="card-subtitle">Watch ads and spin the wheel to earn!</div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 12px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <span>‚è∞</span>
                        <span>Resets in: <strong id="earnResetTimer">${formatDuration(timeUntilReset)}</strong></span>
                    </div>
                </div>
                
                <!-- Watch Simple Ads -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">üì∫ Watch Simple Ads</h3>
                            <div class="card-subtitle">Earn TON directly to balance</div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <div style="font-weight: 700; margin-bottom: 8px;">üí° How it works:</div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            ‚Ä¢ Earn <strong>0.000010 TON</strong> per ad (base)<br>
                            ‚Ä¢ Level multiplier: <strong>${getLevelInfo(store.profile.level).multiplier}x</strong><br>
                            ‚Ä¢ Batch limit: 200 ads ‚Üí 10min cooldown<br>
                            ‚Ä¢ Daily max: 1000 ads<br>
                            ‚Ä¢ +2 XP per ad watched
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${simpleToday}/${CONFIG.LIMITS.WATCH_SIMPLE_MAX}</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${simpleBatchProgress}/${CONFIG.LIMITS.WATCH_SIMPLE_BATCH}</div>
                            <div class="stat-label">Current Batch</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <div style="font-size: 13px; margin-bottom: 8px; color: var(--text-secondary);">
                            Batch Progress: ${simpleBatchProgress}/${CONFIG.LIMITS.WATCH_SIMPLE_BATCH}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(simpleBatchProgress / CONFIG.LIMITS.WATCH_SIMPLE_BATCH) * 100}%"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary btn-block" style="margin-top: 16px;" id="watchSimpleBtn" onclick="window.app.handleWatchSimpleAd()">
                        ‚ñ∂Ô∏è Watch Ad Now
                    </button>
                    <div id="watchSimpleCooldown" style="text-align: center; margin-top: 8px; font-size: 13px; color: var(--accent-orange);"></div>
                </div>
                
                <!-- Lucky Wheel -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">üé∞ Lucky Wheel (Coins)</h3>
                            <div class="card-subtitle">Watch ads for coins, spin for prizes!</div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <div style="font-weight: 700; margin-bottom: 8px;">üí° How it works:</div>
                        <div style="font-size: 13px; line-height: 1.6;">
                            ‚Ä¢ Watch ads to earn <strong>Coins ü™ô</strong><br>
                            ‚Ä¢ 1 ad = 1 coin (+2 XP)<br>
                            ‚Ä¢ Batch: 50 ads ‚Üí 10min cooldown<br>
                            ‚Ä¢ Daily max: 250 ads<br>
                            ‚Ä¢ Spin wheel: 1 coin per spin<br>
                            ‚Ä¢ Win 0.000008‚Äì0.000012 TON!
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.coins_current || 0} ü™ô</div>
                            <div class="stat-label">Coins Available</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${coinsToday}/${CONFIG.LIMITS.LUCKY_WHEEL_MAX}</div>
                            <div class="stat-label">Ads Today</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <div style="font-size: 13px; margin-bottom: 8px; color: var(--text-secondary);">
                            Batch Progress: ${coinsBatchProgress}/${CONFIG.LIMITS.LUCKY_WHEEL_BATCH}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(coinsBatchProgress / CONFIG.LIMITS.LUCKY_WHEEL_BATCH) * 100}%"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary btn-block" style="margin-top: 16px;" id="watchCoinBtn" onclick="window.app.handleWatchCoinAd()">
                        ‚ñ∂Ô∏è Watch Ad for Coin
                    </button>
                    <div id="watchCoinCooldown" style="text-align: center; margin-top: 8px; font-size: 13px; color: var(--accent-orange);"></div>
                    
                    ${store.profile.coins_current > 0 ? `
                        <button class="btn btn-primary btn-block" style="margin-top: 12px;" onclick="window.app.showLuckyWheel()">
                            üé∞ Spin Lucky Wheel
                        </button>
                    ` : ''}
                </div>
            `;
            
            startResetCountdownTimer('earnResetTimer');
            updateWatchCooldowns();
        }
        
        function renderMiningTab(container) {
            const levelInfo = getLevelInfo(store.profile.level);
            const miningReward = levelInfo.autoMining || 0.0002;
            const miningStartTime = store.profile.mining_start_time;
            const miningDuration = 3 * 60 * 60 * 1000; // 3 hours
            
            let statusHTML = '';
            let buttonHTML = '';
            
            if (!miningStartTime) {
                statusHTML = `
                    <div class="mining-timer">Ready to mine!</div>
                    <div style="font-size: 14px; color: var(--text-muted);">Start mining to earn ${formatTON(miningReward)} TON</div>
                `;
                buttonHTML = `<button class="btn btn-primary btn-block" onclick="window.app.handleStartMining()">üöÄ Start Mining</button>`;
            } else {
                const now = getServerTime();
                const start = new Date(miningStartTime).getTime();
                const elapsed = now - start;
                const remaining = miningDuration - elapsed;
                
                if (remaining <= 0) {
                    statusHTML = `
                        <div class="mining-timer">‚úÖ Mining Complete!</div>
                        <div style="font-size: 14px; color: var(--accent-green);">Ready to claim your reward</div>
                    `;
                    buttonHTML = `<button class="btn btn-success btn-block" onclick="window.app.handleClaimMining()">üí∞ Claim ${formatTON(miningReward)} TON</button>`;
                } else {
                    statusHTML = `
                        <div class="mining-timer" id="miningTimer">${formatDuration(remaining)}</div>
                        <div style="font-size: 14px; color: var(--text-muted);">Mining in progress...</div>
                    `;
                    buttonHTML = `<button class="btn btn-primary btn-block" disabled>‚è≥ Mining in Progress</button>`;
                }
            }
            
            const progressPercent = miningStartTime ? 
                Math.min(100, ((getServerTime() - new Date(miningStartTime).getTime()) / miningDuration) * 100) : 0;
            
            container.innerHTML = `
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 8px;">‚õèÔ∏è Auto-Mining</h2>
                    <div class="card-subtitle">Earn TON every 3 hours</div>
                </div>
                
                <div class="mining-card">
                    <div class="mining-icon">‚õèÔ∏è</div>
                    <div style="font-size: 20px; font-weight: 700; color: var(--accent-gold); margin-bottom: 8px;">
                        AUTO-MINING
                    </div>
                    <div class="mining-reward">+${formatTON(miningReward)} TON</div>
                    ${statusHTML}
                    
                    <div class="progress-bar" style="margin-top: 20px; margin-bottom: 20px;">
                        <div class="progress-fill" id="miningProgress" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    ${buttonHTML}
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 16px;">üìä Mining Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.mining_count || 0}</div>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.daily_mining_opens || 0}</div>
                            <div class="stat-label">Opens Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${store.profile.level}</div>
                            <div class="stat-label">Current Level</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${formatTON(miningReward)}</div>
                            <div class="stat-label">Reward/Session</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">üíé Level Rewards</h3>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                        ü•â Bronze: 0.00020 TON<br>
                        ü•à Silver: 0.00035 TON<br>
                        ü•á Gold: 0.00050 TON<br>
                        ‚≠ê Platinum: 0.00065 TON<br>
                        üíé Diamond: 0.00080 TON
                    </div>
                    <div class="info-box" style="margin-top: 12px;">
                        <div style="font-size: 13px;">
                            <strong>Your level: ${store.profile.level}</strong><br>
                            Earning: ${formatTON(miningReward)} TON per session
                        </div>
                    </div>
                </div>
            `;
            
            if (miningStartTime && progressPercent < 100) {
                startMiningTimer();
            }
        }
        
        function renderTasksTab(container) {
            container.innerHTML = `
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 8px;">üìã Tasks & Quests</h2>
                    <div class="card-subtitle">Complete tasks to earn TON</div>
                </div>
                
                <div id="tasksContent">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <div>Loading tasks...</div>
                    </div>
                </div>
            `;
            
            loadTasks();
        }
        
        async function loadTasks() {
            try {
                // Load daily quests
                const questsData = await fetchQuestsProgress();
                
                // Load one-time tasks
                const oneTimeTasks = [
                    {
                        id: 'join_channel',
                        icon: 'üì¢',
                        title: 'Join Main Channel',
                        description: 'Join our Telegram channel',
                        reward: 0.0001,
                        status: store.profile.tasks_done?.includes('join_channel') ? 'completed' : 'available',
                        url: `https://t.me/${CONFIG.CHANNEL_USERNAME}`
                    },
                    {
                        id: 'join_withdraw_channel',
                        icon: 'üí∏',
                        title: 'Join Withdrawal Proofs',
                        description: 'See real withdrawal proofs',
                        reward: 0.0001,
                        status: store.profile.tasks_done?.includes('join_withdraw_channel') ? 'completed' : 'available',
                        url: `https://t.me/${CONFIG.WITHDRAW_CHANNEL_USERNAME}`
                    }
                ];
                
                const tasksContent = document.getElementById('tasksContent');
                
                let html = `
                    <!-- Daily Quests -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 12px;">üéØ Daily Quests</h3>
                        <div class="warning-box">
                            <div style="font-size: 13px;">
                                ‚ö†Ô∏è Quests expire at UTC midnight if not claimed!<br>
                                Timer: <strong id="questsResetTimer">${formatDuration(getTimeUntilReset())}</strong>
                            </div>
                        </div>
                    </div>
                `;
                
                // Render daily quests
                ['quest_1', 'quest_2', 'quest_3'].forEach((questKey, index) => {
                    const quest = questsData[questKey];
                    if (!quest) return;
                    
                    const questNum = index + 1;
                    const canClaim = quest.completed && !quest.claimed;
                    const progress = quest.progress;
                    
                    html += `
                        <div class="task-card">
                            <div class="task-icon">üéØ</div>
                            <div class="task-info">
                                <div class="task-title">Daily Quest ${questNum}</div>
                                <div class="task-reward">+${formatTON(quest.reward)} TON</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    Mining: ${progress.mining_opens}<br>
                                    Ads: ${progress.ads_watched}<br>
                                    Coins: ${progress.coins_spent}
                                </div>
                                ${quest.completed && !quest.claimed ? `
                                    <div class="task-progress">
                                        <div class="badge badge-success" style="margin-top: 8px;">‚úÖ Ready to Claim</div>
                                    </div>
                                ` : quest.claimed ? `
                                    <div class="badge badge-gold" style="margin-top: 8px;">‚ú® Claimed</div>
                                ` : ''}
                            </div>
                            ${!quest.claimed ? `
                                <button class="btn ${canClaim ? 'btn-success' : 'btn-secondary'} btn-sm" 
                                    ${!canClaim ? 'disabled' : ''} 
                                    onclick="window.app.handleClaimQuest(${questNum})">
                                    ${canClaim ? 'Claim' : 'Locked'}
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                
                // One-time tasks
                html += `
                    <div class="card" style="margin-top: 20px;">
                        <h3 class="card-title" style="margin-bottom: 12px;">‚ú® One-Time Tasks</h3>
                        <div class="info-box">
                            <div style="font-size: 13px;">
                                üîí Both tasks must be completed before first withdrawal!
                            </div>
                        </div>
                    </div>
                `;
                
                oneTimeTasks.forEach(task => {
                    const completed = task.status === 'completed';
                    html += `
                        <div class="task-card">
                            <div class="task-icon">${task.icon}</div>
                            <div class="task-info">
                                <div class="task-title">${task.title}</div>
                                <div class="task-reward">+${formatTON(task.reward)} TON</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    ${task.description}
                                </div>
                            </div>
                            ${!completed ? `
                                <button class="btn btn-primary btn-sm" id="task_${task.id}_btn" onclick="window.app.handleOneTimeTask('${task.id}', '${task.url}')">
                                    Join
                                </button>
                            ` : `
                                <div class="badge badge-success">‚úÖ Done</div>
                            `}
                        </div>
                    `;
                });
                
                tasksContent.innerHTML = html;
                startResetCountdownTimer('questsResetTimer');
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksContent').innerHTML = `
                    <div class="error-box">
                        <div style="font-weight: 700; margin-bottom: 8px;">‚ùå Error Loading Tasks</div>
                        <div style="font-size: 13px;">${error.message}</div>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="window.app.switchTab('tasks')">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function renderMoreTab(container) {
            container.innerHTML = `
                <div class="card">
                    <h2 class="card-title" style="margin-bottom: 8px;">‚ãØ More</h2>
                    <div class="card-subtitle">Additional features & info</div>
                </div>
                
                <div class="action-card" onclick="window.app.showLeaderboard()">
                    <div class="action-icon">üèÜ</div>
                    <div class="action-title">Daily Leaderboard</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Your rank: #${store.leaderboard.me.rank || '‚Äî'}
                    </div>
                </div>
                
                <div class="action-card" onclick="window.app.showLevelGuide()">
                    <div class="action-icon">üéÆ</div>
                    <div class="action-title">Level System Guide</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Learn about XP & levels
                    </div>
                </div>
                
                <div class="action-card" onclick="window.app.showWithdraw()">
                    <div class="action-icon">üí∞</div>
                    <div class="action-title">Withdraw</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Cash out to FaucetPay
                    </div>
                </div>
                
                <div class="action-card" onclick="window.app.showWallet()">
                    <div class="action-icon">üíº</div>
                    <div class="action-title">Wallet & History</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        View transactions
                    </div>
                </div>
                
                <div class="action-card" onclick="window.app.showInvite()">
                    <div class="action-icon">üë•</div>
                    <div class="action-title">Invite Friends</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Earn 0.00035 TON per friend
                    </div>
                </div>
                
                <div class="action-card" onclick="window.open('https://t.me/${CONFIG.SUPPORT_USERNAME}', '_blank')">
                    <div class="action-icon">üí¨</div>
                    <div class="action-title">Support</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        Get help
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title" style="margin-bottom: 12px;">‚ÑπÔ∏è App Info</h3>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                        <strong>Version:</strong> 7.0.0 Professional Edition<br>
                        <strong>Your ID:</strong> ${store.profile.telegram_id}<br>
                        <strong>Member Since:</strong> ${store.profile.created_at ? new Date(store.profile.created_at).toLocaleDateString() : '‚Äî'}<br>
                        <strong>Test Mode:</strong> ${store.auth.isTestUser ? 'Yes' : 'No'}
                    </div>
                </div>
            `;
        }
        
        // =====================================================
        // @region ACTION HANDLERS
        // =====================================================
        
        async function handleWatchSimpleAd() {
            const btn = document.getElementById('watchSimpleBtn');
            if (!btn || btn.disabled) return;
            
            // Check batch cooldown
            if (store.profile.ads_watch_simple_batch_cooldown_until) {
                const cooldownEnd = new Date(store.profile.ads_watch_simple_batch_cooldown_until).getTime();
                if (getServerTime() < cooldownEnd) {
                    const remaining = Math.ceil((cooldownEnd - getServerTime()) / 1000);
                    showToast(`Batch cooldown active. Wait ${remaining}s`, 'warning');
                    return;
                }
            }
            
            // Check individual cooldown
            if (store.profile.ads_watch_simple_last_watch) {
                const timeSince = getServerTime() - new Date(store.profile.ads_watch_simple_last_watch).getTime();
                if (timeSince < 5000) {
                    const remaining = Math.ceil((5000 - timeSince) / 1000);
                    showToast(`Wait ${remaining} seconds`, 'warning');
                    return;
                }
            }
            
            // Check daily limit
            if (store.profile.ads_watch_simple_today >= CONFIG.LIMITS.WATCH_SIMPLE_MAX) {
                showToast('Daily limit reached (1000 ads)', 'error');
                return;
            }
            
            try {
                btn.disabled = true;
                const data = await watchAd('simple');
                
                const earnedAmount = data.earned || 0.000010;
                showToast(`üéâ +${formatTON(earnedAmount)} TON earned! (+2 XP)`, 'success');
                
                // Re-render tab
                renderEarnTab(document.getElementById('appContent'));
                
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                btn.disabled = false;
            }
        }
        
        async function handleWatchCoinAd() {
            const btn = document.getElementById('watchCoinBtn');
            if (!btn || btn.disabled) return;
            
            // Similar checks as watchSimple
            if (store.profile.ads_for_coins_batch_cooldown_until) {
                const cooldownEnd = new Date(store.profile.ads_for_coins_batch_cooldown_until).getTime();
                if (getServerTime() < cooldownEnd) {
                    const remaining = Math.ceil((cooldownEnd - getServerTime()) / 1000);
                    showToast(`Batch cooldown active. Wait ${remaining}s`, 'warning');
                    return;
                }
            }
            
            if (store.profile.ads_for_coins_last_watch) {
                const timeSince = getServerTime() - new Date(store.profile.ads_for_coins_last_watch).getTime();
                if (timeSince < 5000) {
                    const remaining = Math.ceil((5000 - timeSince) / 1000);
                    showToast(`Wait ${remaining} seconds`, 'warning');
                    return;
                }
            }
            
            if (store.profile.ads_for_coins_today >= CONFIG.LIMITS.LUCKY_WHEEL_MAX) {
                showToast('Daily limit reached (250 ads)', 'error');
                return;
            }
            
            try {
                btn.disabled = true;
                await watchAd('coin');
                showToast(`ü™ô +1 Coin earned! (+2 XP)`, 'success');
                renderEarnTab(document.getElementById('appContent'));
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                btn.disabled = false;
            }
        }
        
        async function handleStartMining() {
            try {
                await startMining();
                showToast('‚õèÔ∏è Mining started!', 'success');
                renderMiningTab(document.getElementById('appContent'));
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleClaimMining() {
            try {
                const data = await claimMining();
                const levelInfo = getLevelInfo(store.profile.level);
                const reward = levelInfo.autoMining || 0.0002;
                showToast(`üí∞ +${formatTON(reward)} TON claimed!`, 'success');
                renderMiningTab(document.getElementById('appContent'));
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleClaimQuest(questNumber) {
            try {
                const data = await claimQuest(questNumber);
                showToast(`üéâ Quest ${questNumber} claimed! +${formatTON(data.reward)} TON`, 'success');
                loadTasks();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleOneTimeTask(taskId, taskUrl) {
            const btn = document.getElementById(`task_${taskId}_btn`);
            if (!btn) return;
            
            const btnText = btn.textContent.trim();
            
            if (btnText === 'Join') {
                window.open(taskUrl, '_blank');
                btn.textContent = 'Verify';
            } else if (btnText === 'Verify') {
                try {
                    const data = await verifyTask(taskId);
                    if (data.verified) {
                        btn.textContent = 'Claim';
                        showToast('‚úÖ Verification successful!', 'success');
                    } else {
                        showToast('‚ùå Please join the channel first', 'error');
                    }
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                }
            } else if (btnText === 'Claim') {
                try {
                    await claimTask(taskId);
                    showToast('üéâ +0.0001 TON earned!', 'success');
                    loadTasks();
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                }
            }
        }
        
        // =====================================================
        // @region MODAL VIEWS
        // =====================================================
        
        function showLeaderboard() {
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üèÜ Daily Leaderboard</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div class="info-box">
                    <div style="font-weight: 700; margin-bottom: 8px;">üí∞ Daily Rewards:</div>
                    <div style="font-size: 13px;">
                        ü•á 1st Place: 0.003 TON<br>
                        ü•à 2nd Place: 0.002 TON<br>
                        ü•â 3rd Place: 0.001 TON
                    </div>
                </div>
                
                <div style="margin: 16px 0; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 12px;">
                    <div style="font-size: 13px;">
                        ‚è∞ Resets in: <strong id="leaderboardResetTimer">${formatDuration(getTimeUntilReset())}</strong>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding: 12px; background: rgba(102, 126, 234, 0.2); border-radius: 12px;">
                    <div style="font-weight: 700; margin-bottom: 4px;">Your Position:</div>
                    <div style="font-size: 24px; color: var(--accent-gold);">
                        Rank: #${store.leaderboard.me.rank || '‚Äî'} | Ads: ${store.leaderboard.me.adsToday || 0}
                    </div>
                </div>
                
                <div id="leaderboardList">
                    <div class="loading-container"><div class="spinner"></div></div>
                </div>
            `;
            
            showModal(content);
            loadLeaderboardData();
            startResetCountdownTimer('leaderboardResetTimer');
        }
        
        async function loadLeaderboardData() {
            try {
                const data = await fetchLeaderboard();
                await fetchUserRank();
                
                let html = '';
                store.leaderboard.top50.forEach((user, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                    const isTopThree = index < 3;
                    
                    html += `
                        <div class="leaderboard-item" style="${isTopThree ? 'background: rgba(255, 215, 0, 0.1); border-color: var(--accent-gold);' : ''}">
                            <div class="leaderboard-rank ${isTopThree ? 'top-3' : ''}">${medal}</div>
                            <div class="leaderboard-avatar">üë§</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${user.first_name || user.username}</div>
                                <div class="leaderboard-level">${user.level}</div>
                            </div>
                            <div class="leaderboard-stats">
                                <div class="leaderboard-ads">${user.daily_ads_count}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">ads</div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('leaderboardList').innerHTML = html || '<div class="empty-state"><div class="empty-icon">üèÜ</div><div class="empty-text">No rankings yet</div></div>';
            } catch (error) {
                document.getElementById('leaderboardList').innerHTML = `
                    <div class="error-box">
                        <div>‚ùå Error loading leaderboard</div>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="window.app.loadLeaderboardData()">Retry</button>
                    </div>
                `;
            }
        }
        
        function showLevelGuide() {
            const currentLevel = store.profile.level;
            const currentInfo = getLevelInfo(currentLevel);
            const nextLevel = getNextLevel(currentLevel);
            const xpNeeded = nextLevel ? CONFIG.LEVELS[nextLevel].minXP - store.profile.xp : 0;
            
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üéÆ Level System Guide</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div class="level-progress-card">
                    <div class="current-level">${currentLevel}</div>
                    <div class="xp-display">${store.profile.xp} XP</div>
                    <div class="level-multiplier">
                        Multiplier: ${currentInfo.multiplier}x
                    </div>
                    ${nextLevel ? `
                        <div style="margin-top: 16px;">
                            <div style="font-size: 14px; margin-bottom: 8px;">
                                Next: ${nextLevel} (${xpNeeded} XP needed)
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(store.profile.xp / CONFIG.LEVELS[nextLevel].minXP) * 100}%"></div>
                            </div>
                        </div>
                    ` : '<div style="margin-top: 16px; font-size: 14px; color: var(--accent-gold);">üéâ MAX LEVEL REACHED!</div>'}
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">üìä All Levels</h3>
                    <div style="font-size: 13px; line-height: 2; color: var(--text-secondary);">
                        ü•â <strong>Bronze</strong> (0-1999 XP)<br>
                        ‚Ä¢ Multiplier: 1.0x<br>
                        ‚Ä¢ Auto-Mining: 0.00020 TON<br>
                        ‚Ä¢ Min Withdraw: 0.003 TON<br><br>
                        
                        ü•à <strong>Silver</strong> (2000-3999 XP)<br>
                        ‚Ä¢ Multiplier: 1.02x (+2%)<br>
                        ‚Ä¢ Auto-Mining: 0.00035 TON<br>
                        ‚Ä¢ Min Withdraw: 0.001 TON<br><br>
                        
                        ü•á <strong>Gold</strong> (4000-5999 XP)<br>
                        ‚Ä¢ Multiplier: 1.04x (+4%)<br>
                        ‚Ä¢ Auto-Mining: 0.00050 TON<br>
                        ‚Ä¢ Min Withdraw: 0.0009 TON<br><br>
                        
                        ‚≠ê <strong>Platinum</strong> (6000-7999 XP)<br>
                        ‚Ä¢ Multiplier: 1.06x (+6%)<br>
                        ‚Ä¢ Auto-Mining: 0.00065 TON<br>
                        ‚Ä¢ Min Withdraw: 0.0008 TON<br><br>
                        
                        üíé <strong>Diamond</strong> (8000+ XP)<br>
                        ‚Ä¢ Multiplier: 1.08x (+8%)<br>
                        ‚Ä¢ Auto-Mining: 0.00080 TON<br>
                        ‚Ä¢ Min Withdraw: 0.0007 TON
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">‚ö° How to Earn XP</h3>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                        ‚Ä¢ Watch ads: <strong>+2 XP</strong> per ad<br>
                        ‚Ä¢ Watch Simple ads count<br>
                        ‚Ä¢ Watch Lucky Wheel ads count<br>
                        ‚Ä¢ All ads contribute to your XP
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">‚ö†Ô∏è Level Downgrade Rules</h3>
                    <div class="warning-box">
                        <div style="font-size: 13px; line-height: 1.8;">
                            <strong>To maintain your level:</strong><br>
                            ‚Ä¢ Watch at least <strong>300 ads per day</strong><br>
                            ‚Ä¢ Stay active daily<br><br>
                            
                            <strong>Downgrade triggers:</strong><br>
                            ‚Ä¢ Less than 300 ads/day ‚Üí Drop 1 level<br>
                            ‚Ä¢ Full day inactivity ‚Üí Reset to Bronze<br>
                            ‚Ä¢ Warning at 11 PM UTC if below 300
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div style="font-size: 13px; line-height: 1.6;">
                        <strong>üí° Pro Tip:</strong> Higher levels earn more from every action!
                        Keep watching ads daily to maintain and grow your level.
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        function showLuckyWheel() {
            if (store.profile.coins_current < 1) {
                showToast('You need at least 1 coin to spin!', 'error');
                return;
            }
            
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üé∞ Lucky Wheel</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; font-weight: 700; color: var(--accent-gold);">
                        ${store.profile.coins_current} ü™ô
                    </div>
                    <div style="font-size: 14px; color: var(--text-muted);">Coins Available</div>
                </div>
                
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheelCanvas" class="wheel-canvas" width="300" height="300"></canvas>
                    <div class="wheel-center">SPIN</div>
                </div>
                
                <button class="btn btn-primary btn-block" id="spinWheelBtn" onclick="window.app.handleSpinWheel()">
                    üé≤ Spin the Wheel (1 coin)
                </button>
                
                <div class="info-box" style="margin-top: 16px;">
                    <div style="font-size: 13px; text-align: center;">
                        Win 0.000008‚Äì0.000012 TON!<br>
                        Level multiplier: <strong>${getLevelInfo(store.profile.level).multiplier}x</strong>
                    </div>
                </div>
            `;
            
            showModal(content);
            initWheel();
        }
        
        function initWheel() {
            const canvas = document.getElementById('wheelCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 140;
            
            const segments = [
                { label: '0.000009', color: '#64B5F6', icon: 'üíß' },
                { label: '0.000012', color: '#FFD54F', icon: 'üíõ' },
                { label: '0.000010', color: '#42A5F5', icon: 'üíô' },
                { label: '0.000015', color: '#66BB6A', icon: 'üíö' },
                { label: '0.000017', color: '#9C27B0', icon: 'üíé' },
                { label: 'RETRY', color: '#FF9800', icon: 'üîÑ' }
            ];
            
            function drawWheel(rotation = 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const anglePerSegment = (2 * Math.PI) / segments.length;
                
                segments.forEach((segment, i) => {
                    const startAngle = rotation + i * anglePerSegment;
                    const endAngle = startAngle + anglePerSegment;
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fillStyle = segment.color;
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(startAngle + anglePerSegment / 2);
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 24px Arial';
                    ctx.fillText(segment.icon, radius * 0.65, 8);
                    ctx.font = 'bold 11px Arial';
                    ctx.fillText(segment.label, radius * 0.65, 26);
                    ctx.restore();
                });
            }
            
            drawWheel();
            window.drawWheel = drawWheel;
        }
        
        async function handleSpinWheel() {
            const btn = document.getElementById('spinWheelBtn');
            if (!btn || btn.disabled) return;
            
            if (store.profile.coins_current < 1) {
                showToast('Not enough coins!', 'error');
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = 'üé∞ Spinning...';
                
                const data = await spinWheel();
                
                // Animate wheel
                const canvas = document.getElementById('wheelCanvas');
                if (canvas && window.drawWheel) {
                    let currentRotation = 0;
                    const spins = 5;
                    const targetRotation = spins * 2 * Math.PI + (Math.random() * Math.PI / 3);
                    const duration = 3000;
                    const startTime = Date.now();
                    
                    function animate() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        currentRotation = targetRotation * easeOut;
                        window.drawWheel(currentRotation);
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            const result = data.spin_result;
                            if (result === 'RETRY') {
                                showToast('üîÑ FREE SPIN! Try again!', 'success');
                            } else {
                                showToast(`üéâ You won ${formatTON(result)} TON!`, 'success');
                            }
                            closeModal();
                        }
                    }
                    
                    animate();
                } else {
                    const result = data.spin_result;
                    if (result === 'RETRY') {
                        showToast('üîÑ FREE SPIN! Try again!', 'success');
                    } else {
                        showToast(`üéâ You won ${formatTON(result)} TON!`, 'success');
                    }
                    closeModal();
                }
                
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'üé≤ Spin the Wheel (1 coin)';
            }
        }
        
        function showWithdraw() {
            const mandatoryComplete = store.profile.mandatory_tasks_completed;
            const adsWatched = store.profile.withdraw_ads_watched_current || 0;
            const adsRequired = CONFIG.LIMITS.WITHDRAW_ADS_REQUIRED;
            const unlocked = mandatoryComplete && adsWatched >= adsRequired;
            const levelInfo = getLevelInfo(store.profile.level);
            const minWithdraw = levelInfo.minWithdraw || 0.003;
            
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üí∞ Withdraw</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div class="info-box">
                    <div style="font-weight: 700; margin-bottom: 8px;">üí∏ Withdraw to FaucetPay:</div>
                    <div style="font-size: 13px; line-height: 1.6;">
                        ‚Ä¢ Minimum (${store.profile.level}): <strong>${formatTON(minWithdraw)} TON</strong><br>
                        ‚Ä¢ No gas fees!<br>
                        ‚Ä¢ Instant payment<br>
                        ‚Ä¢ Your balance: <strong>${formatTON(store.profile.balance)} TON</strong>
                    </div>
                </div>
                
                <!-- Prerequisites Checklist -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">‚úÖ Requirements</h3>
                    <div class="checklist-item">
                        <div class="checklist-icon ${store.profile.tasks_done?.includes('join_channel') ? 'complete' : 'incomplete'}">
                            ${store.profile.tasks_done?.includes('join_channel') ? '‚úÖ' : '‚≠ï'}
                        </div>
                        <div>Join Main Channel</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-icon ${store.profile.tasks_done?.includes('join_withdraw_channel') ? 'complete' : 'incomplete'}">
                            ${store.profile.tasks_done?.includes('join_withdraw_channel') ? '‚úÖ' : '‚≠ï'}
                        </div>
                        <div>Join Withdrawal Proofs</div>
                    </div>
                    <div class="checklist-item">
                        <div class="checklist-icon ${adsWatched >= adsRequired ? 'complete' : 'incomplete'}">
                            ${adsWatched >= adsRequired ? '‚úÖ' : '‚≠ï'}
                        </div>
                        <div>Watch ${adsRequired} Withdraw Ads (${adsWatched}/${adsRequired})</div>
                    </div>
                </div>
                
                ${!mandatoryComplete ? `
                    <div class="warning-box">
                        <div style="font-weight: 700; margin-bottom: 8px;">üîí Action Required</div>
                        <div style="font-size: 13px; margin-bottom: 12px;">
                            Complete both channel tasks first!
                        </div>
                        <button class="btn btn-secondary btn-block" onclick="window.app.closeModal(); window.app.switchTab('tasks');">
                            Go to Tasks
                        </button>
                    </div>
                ` : adsWatched < adsRequired ? `
                    <div class="warning-box">
                        <div style="font-weight: 700; margin-bottom: 8px;">üîí Watch Ads to Unlock</div>
                        <div style="font-size: 13px; margin-bottom: 12px;">
                            Progress: ${adsWatched}/${adsRequired} ads watched
                        </div>
                        <button class="btn btn-secondary btn-block" id="watchWithdrawAdBtn" onclick="window.app.handleWatchWithdrawAd()">
                            üì∫ Watch Ad (${adsWatched}/${adsRequired})
                        </button>
                    </div>
                ` : `
                    <div class="info-box">
                        <div style="font-size: 13px; text-align: center;">
                            ‚úÖ All requirements met! You can withdraw now.
                        </div>
                    </div>
                    
                    <div class="card">
                        <form id="withdrawForm" onsubmit="event.preventDefault(); window.app.handleSubmitWithdraw();">
                            <div class="form-group">
                                <label class="form-label">FaucetPay Email</label>
                                <input type="email" class="form-input" id="withdrawEmail" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount (min ${formatTON(minWithdraw)} TON)</label>
                                <input type="number" class="form-input" id="withdrawAmount" placeholder="${formatTON(minWithdraw)}" 
                                    min="${minWithdraw}" step="0.000001" max="${store.profile.balance}" required>
                            </div>
                            <button type="submit" class="btn btn-success btn-block">
                                üí∏ Withdraw Now
                            </button>
                        </form>
                    </div>
                `}
                
                <div class="stats-grid" style="margin-top: 16px;">
                    <div class="stat-card">
                        <div class="stat-value">${formatTON(store.profile.total_withdrawn)}</div>
                        <div class="stat-label">Total Withdrawn</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${store.profile.withdraw_history?.length || 0}</div>
                        <div class="stat-label">Withdrawals</div>
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        async function handleWatchWithdrawAd() {
            const btn = document.getElementById('watchWithdrawAdBtn');
            if (!btn || btn.disabled) return;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Loading...';
                
                const data = await watchAd('withdraw');
                const adsWatched = data.ads_watched || 0;
                
                showToast(`‚úÖ Ad ${adsWatched}/${CONFIG.LIMITS.WITHDRAW_ADS_REQUIRED} watched!`, 'success');
                
                if (adsWatched >= CONFIG.LIMITS.WITHDRAW_ADS_REQUIRED) {
                    setTimeout(() => {
                        closeModal();
                        showWithdraw();
                    }, 1000);
                } else {
                    btn.disabled = false;
                    btn.textContent = `üì∫ Watch Ad (${adsWatched}/${CONFIG.LIMITS.WITHDRAW_ADS_REQUIRED})`;
                }
                
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                btn.disabled = false;
            }
        }
        
        async function handleSubmitWithdraw() {
            const email = document.getElementById('withdrawEmail')?.value.trim();
            const amount = document.getElementById('withdrawAmount')?.value;
            
            if (!email || !amount) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            const levelInfo = getLevelInfo(store.profile.level);
            const minWithdraw = levelInfo.minWithdraw || 0.003;
            
            if (parseFloat(amount) < minWithdraw) {
                showToast(`Minimum ${formatTON(minWithdraw)} TON`, 'error');
                return;
            }
            
            if (parseFloat(amount) > store.profile.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            try {
                const form = document.getElementById('withdrawForm');
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = '‚è≥ Processing...';
                    }
                }
                
                await submitWithdraw(email, amount);
                showToast('üéâ Withdrawal successful!', 'success');
                closeModal();
                
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                const form = document.getElementById('withdrawForm');
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üí∏ Withdraw Now';
                    }
                }
            }
        }
        
        function showWallet() {
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üíº Wallet & History</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${formatTON(store.profile.balance)}</div>
                        <div class="stat-label">Current Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatTON(store.profile.earnings_total)}</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatTON(store.profile.total_withdrawn)}</div>
                        <div class="stat-label">Total Withdrawn</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${store.profile.coins_current || 0}</div>
                        <div class="stat-label">Coins</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 16px;">
                    <h3 class="card-title" style="margin-bottom: 12px;">üìú Recent Withdrawals</h3>
                    <div id="withdrawHistory">
                        ${renderWithdrawHistory()}
                    </div>
                </div>
            `;
            
            showModal(content);
        }
        
        function renderWithdrawHistory() {
            const history = store.profile.withdraw_history || [];
            
            if (history.length === 0) {
                return '<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-text">No withdrawals yet</div></div>';
            }
            
            return history.slice(0, 10).map(item => `
                <div class="history-item">
                    <div class="history-icon">${item.status === 'success' ? '‚úÖ' : '‚ùå'}</div>
                    <div class="history-info">
                        <div class="history-title">${item.status === 'success' ? 'Withdrawal Successful' : 'Withdrawal Failed'}</div>
                        <div class="history-time">${formatTimeAgo(item.date)}</div>
                    </div>
                    <div class="history-amount">${formatTON(item.amount)}</div>
                </div>
            `).join('');
        }
        
        function showInvite() {
            const inviteLink = `https://t.me/${CONFIG.BOT_USERNAME}?start=${store.profile.telegram_id}`;
            const inviteText = `üéâ Join TON Reward DJDN v7.0! üí∞ New Level System! üéÆ\n\n${inviteLink}`;
            
            const content = `
                <div class="modal-header">
                    <h2 class="modal-title">üë• Invite Friends</h2>
                    <button class="modal-close" onclick="window.app.closeModal()">‚úï</button>
                </div>
                
                <div class="info-box">
                    <div style="font-weight: 700; margin-bottom: 8px;">üí∞ How it works:</div>
                    <div style="font-size: 13px; line-height: 1.6;">
                        ‚Ä¢ Share your invite link<br>
                        ‚Ä¢ Friends must open the app<br>
                        ‚Ä¢ Earn <strong>0.00035 TON</strong> per friend!
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${store.profile.invitations_count || 0}</div>
                        <div class="stat-label">Friends Invited</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatTON((store.profile.invitations_count || 0) * 0.00035)}</div>
                        <div class="stat-label">Earned from Invites</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 12px;">üîó Your Invite Link</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; font-size: 12px; word-break: break-all; margin-bottom: 12px;">
                        ${inviteLink}
                    </div>
                    <button class="btn btn-primary btn-block" onclick="window.app.copyInviteLink('${inviteLink}')">
                        üìã Copy Link
                    </button>
                    <button class="btn btn-secondary btn-block" style="margin-top: 8px;" onclick="window.app.shareInvite('${encodeURIComponent(inviteText)}')">
                        üì§ Share via Telegram
                    </button>
                </div>
            `;
            
            showModal(content);
        }
        
        function copyInviteLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showToast('üìã Link copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        function shareInvite(text) {
            window.open(`https://t.me/share/url?url=${text}`, '_blank');
        }
        
        // =====================================================
        // @region TIMERS & INTERVALS
        // =====================================================
        
        function startResetCountdownTimer(elementId) {
            const updateTimer = () => {
                const element = document.getElementById(elementId);
                if (!element) {
                    if (store.timers.resetCountdown) {
                        clearInterval(store.timers.resetCountdown);
                        store.timers.resetCountdown = null;
                    }
                    return;
                }
                
                const remaining = getTimeUntilReset();
                element.textContent = formatDuration(remaining);
            };
            
            if (store.timers.resetCountdown) {
                clearInterval(store.timers.resetCountdown);
            }
            
            updateTimer();
            store.timers.resetCountdown = setInterval(updateTimer, 1000);
        }
        
        function startMiningTimer() {
            const updateTimer = () => {
                const element = document.getElementById('miningTimer');
                const progress = document.getElementById('miningProgress');
                
                if (!element || !progress || !store.profile.mining_start_time) {
                    if (store.timers.mining) {
                        clearInterval(store.timers.mining);
                        store.timers.mining = null;
                    }
                    return;
                }
                
                const now = getServerTime();
                const start = new Date(store.profile.mining_start_time).getTime();
                const duration = 3 * 60 * 60 * 1000;
                const elapsed = now - start;
                const remaining = duration - elapsed;
                
                if (remaining <= 0) {
                    clearInterval(store.timers.mining);
                    store.timers.mining = null;
                    renderMiningTab(document.getElementById('appContent'));
                    return;
                }
                
                element.textContent = formatDuration(remaining);
                const progressPercent = Math.min(100, (elapsed / duration) * 100);
                progress.style.width = progressPercent + '%';
            };
            
            if (store.timers.mining) {
                clearInterval(store.timers.mining);
            }
            
            updateTimer();
            store.timers.mining = setInterval(updateTimer, 1000);
        }
        
        function updateWatchCooldowns() {
            // Watch Simple cooldown
            const updateSimpleCooldown = () => {
                const btn = document.getElementById('watchSimpleBtn');
                const cooldownEl = document.getElementById('watchSimpleCooldown');
                
                if (!btn || !cooldownEl) {
                    if (store.timers.watchSimpleCooldown) {
                        clearInterval(store.timers.watchSimpleCooldown);
                        store.timers.watchSimpleCooldown = null;
                    }
                    return;
                }
                
                // Check batch cooldown
                if (store.profile.ads_watch_simple_batch_cooldown_until) {
                    const cooldownEnd = new Date(store.profile.ads_watch_simple_batch_cooldown_until).getTime();
                    const remaining = cooldownEnd - getServerTime();
                    
                    if (remaining > 0) {
                        btn.disabled = true;
                        cooldownEl.textContent = `‚è∞ Batch cooldown: ${formatDuration(remaining)}`;
                        return;
                    }
                }
                
                // Check individual cooldown
                if (store.profile.ads_watch_simple_last_watch) {
                    const lastWatch = new Date(store.profile.ads_watch_simple_last_watch).getTime();
                    const timeSince = getServerTime() - lastWatch;
                    const remaining = 5000 - timeSince;
                    
                    if (remaining > 0) {
                        btn.disabled = true;
                        cooldownEl.textContent = `‚è∞ Next ad in ${Math.ceil(remaining / 1000)}s`;
                        return;
                    }
                }
                
                // Check daily limit
                if (store.profile.ads_watch_simple_today >= CONFIG.LIMITS.WATCH_SIMPLE_MAX) {
                    btn.disabled = true;
                    cooldownEl.textContent = '‚ö†Ô∏è Daily limit reached';
                    return;
                }
                
                btn.disabled = false;
                cooldownEl.textContent = '';
            };
            
            // Watch Coin cooldown
            const updateCoinCooldown = () => {
                const btn = document.getElementById('watchCoinBtn');
                const cooldownEl = document.getElementById('watchCoinCooldown');
                
                if (!btn || !cooldownEl) {
                    if (store.timers.watchCoinsCooldown) {
                        clearInterval(store.timers.watchCoinsCooldown);
                        store.timers.watchCoinsCooldown = null;
                    }
                    return;
                }
                
                // Check batch cooldown
                if (store.profile.ads_for_coins_batch_cooldown_until) {
                    const cooldownEnd = new Date(store.profile.ads_for_coins_batch_cooldown_until).getTime();
                    const remaining = cooldownEnd - getServerTime();
                    
                    if (remaining > 0) {
                        btn.disabled = true;
                        cooldownEl.textContent = `‚è∞ Batch cooldown: ${formatDuration(remaining)}`;
                        return;
                    }
                }
                
                // Check individual cooldown
                if (store.profile.ads_for_coins_last_watch) {
                    const lastWatch = new Date(store.profile.ads_for_coins_last_watch).getTime();
                    const timeSince = getServerTime() - lastWatch;
                    const remaining = 5000 - timeSince;
                    
                    if (remaining > 0) {
                        btn.disabled = true;
                        cooldownEl.textContent = `‚è∞ Next ad in ${Math.ceil(remaining / 1000)}s`;
                        return;
                    }
                }
                
                // Check daily limit
                if (store.profile.ads_for_coins_today >= CONFIG.LIMITS.LUCKY_WHEEL_MAX) {
                    btn.disabled = true;
                    cooldownEl.textContent = '‚ö†Ô∏è Daily limit reached';
                    return;
                }
                
                btn.disabled = false;
                cooldownEl.textContent = '';
            };
            
            if (store.timers.watchSimpleCooldown) {
                clearInterval(store.timers.watchSimpleCooldown);
            }
            if (store.timers.watchCoinsCooldown) {
                clearInterval(store.timers.watchCoinsCooldown);
            }
            
            updateSimpleCooldown();
            updateCoinCooldown();
            
            store.timers.watchSimpleCooldown = setInterval(updateSimpleCooldown, 1000);
            store.timers.watchCoinsCooldown = setInterval(updateCoinCooldown, 1000);
        }
        
        // =====================================================
        // @region INITIALIZATION
        // =====================================================
        
        async function initializeApp() {
            try {
                console.log('üöÄ Initializing TON Reward DJDN v7.0...');
                
                // Get Telegram user data
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    store.auth.telegram = tg.initDataUnsafe.user;
                    store.auth.isTestUser = false;
                    console.log('‚úÖ Telegram user detected:', store.auth.telegram.id);
                } else {
                    // Test mode
                    store.auth.telegram = {
                        id: 'test_' + Date.now(),
                        first_name: 'Test User',
                        username: 'testuser'
                    };
                    store.auth.isTestUser = true;
                    console.log('‚ö†Ô∏è Test mode active');
                }
                
                // Show loading state
                document.getElementById('appContent').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <div style="margin-top: 16px;">Loading your profile...</div>
                    </div>
                `;
                
                // Fetch or create user
                try {
                    await fetchUserProfile();
                } catch (error) {
                    if (error.message.includes('404') || error.message.includes('not found')) {
                        const telegramId = store.auth.telegram.id;
                        const username = store.auth.telegram.username || store.auth.telegram.first_name || 'User';
                        const firstName = store.auth.telegram.first_name || username;
                        const referrerId = tg?.initDataUnsafe?.start_param || null;
                        
                        const userData = await createUser(telegramId, username, firstName, referrerId);
                        Object.assign(store.profile, userData);
                    } else {
                        throw error;
                    }
                }
                
                // Fetch leaderboard data
                await fetchLeaderboard();
                await fetchUserRank();
                
                // Initialize UI
                updateHeader();
                
                // Setup navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        switchTab(item.dataset.tab);
                    });
                });
                
                // Render home tab
                renderHomeTab(document.getElementById('appContent'));
                
                // Mark as initialized
                store.ui.initialized = true;
                
                // Start periodic refresh (every 30 seconds)
                setInterval(async () => {
                    try {
                        await fetchUserProfile();
                        await fetchUserRank();
                    } catch (error) {
                        console.error('Background refresh error:', error);
                    }
                }, 30000);
                
                // Check for UTC reset every minute
                setInterval(() => {
                    const now = new Date();
                    if (now.getUTCHours() === 0 && now.getUTCMinutes() === 0) {
                        // Midnight UTC - refresh everything
                        setTimeout(() => {
                            fetchUserProfile();
                            fetchLeaderboard();
                            fetchUserRank();
                            if (store.ui.activeTab === 'home') {
                                renderHomeTab(document.getElementById('appContent'));
                            }
                        }, 5000); // Wait 5 seconds for server reset
                    }
                }, 60000);
                
                console.log('‚úÖ App initialized successfully');
                
                // Show welcome toast
                if (store.profile.xp === 0) {
                    setTimeout(() => {
                        showToast('üëã Welcome! Start watching ads to earn TON!', 'success');
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                
                document.getElementById('appContent').innerHTML = `
                    <div class="card">
                        <div class="error-box">
                            <div style="font-weight: 700; margin-bottom: 12px;">‚ùå Initialization Error</div>
                            <div style="font-size: 14px; margin-bottom: 16px;">${error.message}</div>
                            <button class="btn btn-secondary btn-block" onclick="location.reload()">
                                üîÑ Retry
                            </button>
                            <div style="margin-top: 12px; text-align: center;">
                                <a href="https://t.me/${CONFIG.SUPPORT_USERNAME}" target="_blank" style="color: var(--accent-gold); text-decoration: none;">
                                    üí¨ Contact Support
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // =====================================================
        // @region GLOBAL APP INTERFACE
        // =====================================================
        
        window.app = {
            // Navigation
            switchTab,
            
            // Actions
            handleWatchSimpleAd,
            handleWatchCoinAd,
            handleStartMining,
            handleClaimMining,
            handleClaimQuest,
            handleOneTimeTask,
            handleSpinWheel,
            handleWatchWithdrawAd,
            handleSubmitWithdraw,
            
            // Modals
            showLeaderboard,
            showLevelGuide,
            showLuckyWheel,
            showWithdraw,
            showWallet,
            showInvite,
            closeModal,
            
            // Data loaders
            loadLeaderboardData,
            
            // Utilities
            copyInviteLink,
            shareInvite,
            
            // Store access (for debugging)
            getStore: () => store
        };
        
        // =====================================================
        // @region START APPLICATION
        // =====================================================
        
        // Wait for DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Handle visibility change (tab backgrounding)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && store.ui.initialized) {
                // Tab became visible - refresh data
                fetchUserProfile().catch(console.error);
            }
        });
        
        // Handle online/offline
        window.addEventListener('online', () => {
            showToast('‚úÖ Connection restored', 'success');
            if (store.ui.initialized) {
                fetchUserProfile().catch(console.error);
            }
        });
        
        window.addEventListener('offline', () => {
            showToast('‚ö†Ô∏è Connection lost', 'warning');
        });
        
        // Clean up on unload
        window.addEventListener('beforeunload', () => {
            // Clear all timers
            Object.values(store.timers).forEach(timer => {
                if (timer) clearInterval(timer);
            });
        });
        
        // Error boundary
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showToast('An error occurred. Please refresh.', 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showToast('An error occurred. Please try again.', 'error');
        });
        
        // Prevent accidental navigation
        window.addEventListener('beforeunload', (event) => {
            if (store.profile.balance > 0 && !store.profile.withdraw_done) {
                event.preventDefault();
                event.returnValue = '';
                return '';
            }
        });
        
        console.log('üì± TON Reward DJDN v7.0 - Professional Edition');
        console.log('‚ú® Script loaded successfully');
        console.log('üéÆ Features: Level System, Leaderboard, Daily Quests, Smart Limits');
        console.log('üîí Security: Server-side validation, Anti-abuse, Rate limiting');
        console.log('‚ö° Performance: Optimized, Cached, Responsive');
        console.log('üåê Network: Auto-retry, Offline support, Real-time sync');
        console.log('');
        console.log('Developed with ‚ù§Ô∏è for the TON community');
        
    </script>
</body>
</html>